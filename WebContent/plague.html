<html>

<head>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background-color: darkgray;
        }

        #container {
            background-color: white;
        }
    </style>
</head>

<body>
    <div id="container">
    </div>

    <script type="text/javascript">

        (function ($, undefined) {

            let init = function () {
                var vendors = ['webkit', 'moz']
                for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame']
                    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame']
                }

                var lastTime = 0
                if (!window.requestAnimationFrame) {
                    window.requestAnimationFrame = function (callback, element) {
                        var currTime = performance.now()
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime))
                        var id = setTimeout(() => {
                            callback(currTime + timeToCall)
                        }, timeToCall)
                        lastTime = currTime + timeToCall
                        return id
                    }
                }

                if (!window.cancelAnimationFrame) {
                    window.cancelAnimationFrame = function (id) {
                        clearTimeout(id)
                    }
                }

            }

            let itemId = 0

            let nextItemId = () => {
                console.log(itemId)
                return itemId++
            }

            class Core {

                constructor(containerId, width, height) {
                    this.config = {
                        width: 0,
                        height: 0,
                        running: false,
                        debug: true,
                        tps: 25,
                        maxFrameSkip: 5
                    }

                    this.ctx = null
                    this.canvas = null
                    this.container = null
                    this.input = null
                    this.items = null

                    this.handleInput = this.handleInput.bind(this)
                    this.update = this.update.bind(this)
                    this.render = this.render.bind(this)
                    this.log = this.log.bind(this)
                    this.setup = this.setup.bind(this)
                    this.start = this.start.bind(this)
                    this.stop = this.stop.bind(this)
                    this.addListener = this.addListener.bind(this)
                    this.resetMouse = this.resetMouse.bind(this)
                    this.initListeners = this.initListeners.bind(this)
                    this.setDebug = this.setDebug.bind(this)
                    this.addItem = this.addItem.bind(this)
                    this.deleteItem = this.deleteItem.bind(this)
                    this.getContext = this.getContext.bind(this)

                    this.setup(containerId, width, height)
                }

                handleInput = () => {
                    for (let i in this.items) {
                        if (this.items.hasOwnProperty(i)) {
                            let item = this.items[i]
                            if (item.isToDelete()) {
                                this.deleteItem(i)
                                continue
                            }
                            if (item.isActive() && item.handleInput) {
                                item.handleInput(this.input)
                            }
                        }
                    }
                }

                update = (t) => {
                    for (let i in this.items) {
                        if (this.items.hasOwnProperty(i)) {
                            let item = this.items[i]
                            if (item.isToDelete()) {
                                this.deleteItem(i)
                                continue
                            }
                            if (item.isActive() && item.update) {
                                item.update(t)
                            }
                        }
                    }
                }

                render = (alpha) => {
                    this.ctx.clearRect(0, 0, this.config.width, this.config.height)
                    for (let i in this.items) {
                        if (this.items.hasOwnProperty(i)) {
                            let item = this.items[i]
                            if (item.isToDelete()) {
                                this.deleteItem(i)
                                continue;
                            }
                            if (item.isVisible() && item.render) {
                                item.render(this.ctx, alpha)
                            }
                        }
                    }
                }

                log = (item) => {
                    if (this.config.debug) {
                        console.log(item)
                    }
                }

                setup = (containerId, width, height) => {

                    this.container = document.getElementById(containerId)
                    this.config.width = width
                    this.config.height = height

                    this.canvas = document.createElement('canvas')
                    this.canvas.width = width
                    this.canvas.height = height

                    if (typeof (this.canvas.getContext) === undefined) {
                        throw new Error('not canvas')
                    }

                    this.container.appendChild(this.canvas)
                    this.container.style.width = this.canvas.width + 'px'
                    this.container.style.height = this.canvas.height + 'px'

                    this.ctx = this.canvas.getContext('2d')
                    this.items = {}
                }

                start = function () {
                    var self = this;
                    this.config.running = true

                    var dt = 1000 / this.config.tps;
                    var currentTime = performance.now();
                    var accumulator = 0
                    var t = 0

                    let loop = (timestamp) => {

                        self.handleInput()

                        var newTime = performance.now()
                        var frameTime = newTime - currentTime
                        if (frameTime > 1000 / self.config.maxFrameSkip) {
                            frameTime = 1000 / self.config.maxFrameSkip
                        }
                        currentTime = newTime
                        accumulator += frameTime
                        while (accumulator >= dt) {
                            self.update(dt)
                            accumulator -= dt
                            t += dt
                        }

                        let alpha = accumulator / dt
                        self.render(alpha)

                        if (self.config.running) {
                            window.requestAnimationFrame(loop)
                        }
                    }

                    loop(performance.now())

                }

                stop = () => {
                    this.config.running = false
                }

                addListener = (name, callback) => {
                    this.container.addEventListener(name, callback, false)
                }

                resetMouse = () => {
                    var self = this
                    self.input['click'] = false
                    self.input['mousedown'] = false
                    self.input['mouseup'] = false
                }

                initListeners = () => {
                    var self = this
                    self.input = {}

                    this.addListener('keydown', (key) => {
                        self.input[key.code] = true
                        self.log(key)
                    }, false)

                    this.addListener('keyup', (key) => {
                        self.input[key.code] = false
                        self.log(key)
                    }, false)

                    this.addListener('click', (evt) => {
                        self.input['click'] = true
                        self.input['mouseX'] = evt.clientX
                        self.input['mouseY'] = evt.clientY
                        self.log(evt)
                    }, false)

                    this.addListener('mousedown', (evt) => {
                        self.input['mousedown'] = true
                        self.input['mouseX'] = evt.clientX
                        self.input['mouseY'] = evt.clientY
                        self.log(evt)
                    }, false)

                    this.addListener('mouseup', (evt) => {
                        self.input['mouseup'] = true
                        self.input['mouseX'] = evt.clientX
                        self.input['mouseY'] = evt.clientY
                        self.log(evt)
                    }, false)

                    this.addListener('mousemove', (evt) => {
                        self.input['mouseX'] = evt.clientX
                        self.input['mouseY'] = evt.clientY
                        self.log(evt)
                    }, false)

                    this.container.focus()
                }

                setDebug = (debug) => {
                    this.config.debug = debug
                }

                addItem = (item) => {
                    this.items[item.getId()] = item
                }

                deleteItem = (item) => {
                    delete this.items[item.getId()]
                }

                getContext = () => {
                    return this.ctx
                }

            }

            class Item {
                constructor(x, y, w, h) {
                    let data = {}
                    data.id = nextItemId()
                    data.x = x || 0
                    data.y = y || 0
                    data.w = w || 10
                    data.h = h || 10
                    data.color = 'white'
                    data.border = 'black'
                    data.visible = true
                    data.active = false
                    data.toDelete = false

                    this.data = data
  
                    this.handleInput = this.handleInput.bind(this)
                    this.update = this.update.bind(this)
                    this.render = this.render.bind(this)
                    this.getId = this.getId.bind(this)
                    this.hide = this.hide.bind(this)
                    this.show = this.show.bind(this)
                    this.setToDelete = this.setToDelete.bind(this)
                    this.activate = this.activate.bind(this)
                    this.deactivate = this.deactivate.bind(this)
                    this.isToDelete = this.isToDelete.bind(this)
                    this.isActive = this.isActive.bind(this)
                    this.isVisible = this.isVisible.bind(this)
                    this.collide = this.collide.bind(this)

                }

                handleInput = (input) => {

                }

                update = (t) => {

                }

                render = (ctx, alpha) => {
                    ctx.beginPath();
                    ctx.rect(this.data.x, this.data.y, this.data.w, this.data.h)
                    ctx.fillStyle = this.data.color;
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = this.data.border;
                    ctx.stroke();
                }

                getId = () => {
                    return this.data.id
                }

                hide = () => {
                    this.data.visible = false;
                }

                show = () => {
                    this.data.visible = true;
                }

                setToDelete = () =>{
                    this.data.toDelete = true;
                }

                activate =  () =>{
                    this.data.active = true;
                }

                deactivate =  () => {
                    this.data.active = false;
                }

                isToDelete = () =>{
                    return this.data.toDelete;
                }

                isActive = () => {
                    return this.data.active;
                }

                isVisible =  () => {
                    return this.data.visible;
                }

                collide = (x, y, w, h) => {
                    if ((x >= this.data.x && x <= (this.data.x + this.data.w) && y >= this.data.y && y <= (this.data.y + this.data.h)) ||
                        ((x + w) >= this.data.x && (x + w) <= (this.data.x + this.data.w) && y >= this.data.y && y <= (this.data.y + this.data.h)) ||
                        ((x + w) >= this.data.x && x <= (this.data.x + this.data.w) && (y + h) >= this.data.y && (y + h) <= (this.data.y + this.data.h)) ||
                        ((x + w) >= this.data.x && x <= (this.data.x + this.data.w) && (y + h) >= this.data.y && (y + h) <= (this.data.y + this.data.h))
                    ) {
                        return this
                    } else {
                        return false
                    }
                }

            }

            $.Core = Core
            $.Item = Item;

            init()

        }(window.thePlague = window.thePlague || {}))

        let c = new thePlague.Core('container', 300, 200)
        c.start()

        for(let i=5;i<200;i+=20){
            let item = new thePlague.Item(i,20,10,10)
            c.addItem(item)
        }
        

    </script>
</body>

</html>
